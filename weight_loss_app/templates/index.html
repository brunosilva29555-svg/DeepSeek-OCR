{% extends "base.html" %}

{% block title %}Dashboard - Emagrecimento Saud치vel{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <h2>Dashboard</h2>
        <p class="subtitle">Acompanhe seu progresso de emagrecimento</p>
    </div>

    {% if not profile %}
    <!-- Formul치rio de Perfil Inicial -->
    <div class="card welcome-card">
        <h3>游녦 Bem-vindo ao FitLife!</h3>
        <p>Para come칞ar, vamos criar seu perfil e definir suas metas.</p>
        
        <form id="profileForm" class="form">
            <div class="form-row">
                <div class="form-group">
                    <label for="nome">Nome</label>
                    <input type="text" id="nome" name="nome" required>
                </div>
                
                <div class="form-group">
                    <label for="idade">Idade</label>
                    <input type="number" id="idade" name="idade" min="10" max="120" required>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="sexo">Sexo</label>
                    <select id="sexo" name="sexo" required>
                        <option value="">Selecione</option>
                        <option value="M">Masculino</option>
                        <option value="F">Feminino</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="altura">Altura (cm)</label>
                    <input type="number" id="altura" name="altura" min="100" max="250" step="0.1" required>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="peso_inicial">Peso Atual (kg)</label>
                    <input type="number" id="peso_inicial" name="peso_inicial" min="30" max="300" step="0.1" required>
                </div>
                
                <div class="form-group">
                    <label for="peso_meta">Peso Meta (kg)</label>
                    <input type="number" id="peso_meta" name="peso_meta" min="30" max="300" step="0.1" required>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="nivel_atividade">N칤vel de Atividade</label>
                    <select id="nivel_atividade" name="nivel_atividade" required>
                        <option value="sedentario">Sedent치rio (pouco ou nenhum exerc칤cio)</option>
                        <option value="leve">Leve (exerc칤cio 1-3 dias/semana)</option>
                        <option value="moderado">Moderado (exerc칤cio 3-5 dias/semana)</option>
                        <option value="intenso">Intenso (exerc칤cio 6-7 dias/semana)</option>
                        <option value="muito_intenso">Muito Intenso (exerc칤cio 2x/dia)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="objetivo">Velocidade de Emagrecimento</label>
                    <select id="objetivo" name="objetivo" required>
                        <option value="lento">Lento (0.25-0.5 kg/semana)</option>
                        <option value="moderado">Moderado (0.5-0.75 kg/semana)</option>
                        <option value="rapido">R치pido (0.75-1 kg/semana)</option>
                    </select>
                </div>
            </div>

            <button type="submit" class="btn btn-primary">Criar Perfil</button>
        </form>
    </div>
    {% else %}
    <!-- Dashboard com Estat칤sticas -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">丘뒲잺</div>
            <div class="stat-content">
                <h4>Peso Atual</h4>
                <p class="stat-value">{{ stats.peso_atual if stats else profile.peso_inicial }} kg</p>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">游꿢</div>
            <div class="stat-content">
                <h4>Meta</h4>
                <p class="stat-value">{{ stats.peso_meta if stats else profile.peso_meta }} kg</p>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">游늴</div>
            <div class="stat-content">
                <h4>Peso Perdido</h4>
                <p class="stat-value">{{ stats.peso_perdido if stats else 0 }} kg</p>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">游늵</div>
            <div class="stat-content">
                <h4>Progresso</h4>
                <p class="stat-value">{{ stats.percentual_completo if stats else 0 }}%</p>
            </div>
        </div>
    </div>

    {% if stats %}
    <div class="card">
        <h3>Barra de Progresso</h3>
        <div class="progress-bar-container">
            <div class="progress-bar" style="width: {{ stats.percentual_completo }}%"></div>
        </div>
        <p class="progress-text">
            Faltam {{ stats.peso_restante }} kg para atingir sua meta!
        </p>
    </div>
    {% endif %}

    <!-- Registro R치pido de Peso -->
    <div class="card">
        <h3>游닇 Registrar Peso</h3>
        <form id="quickWeightForm" class="form-inline">
            <div class="form-group">
                <label for="quick_peso">Peso (kg)</label>
                <input type="number" id="quick_peso" name="peso" min="30" max="300" step="0.1" required>
            </div>
            <div class="form-group">
                <label for="quick_data">Data</label>
                <input type="date" id="quick_data" name="data" value="{{ today }}" required>
            </div>
            <button type="submit" class="btn btn-primary">Adicionar</button>
        </form>
    </div>

    <!-- Hist칩rico Recente -->
    {% if weight_history %}
    <div class="card">
        <h3>游늰 Hist칩rico Recente</h3>
        <div class="table-responsive">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>Peso</th>
                        <th>Varia칞칚o</th>
                    </tr>
                </thead>
                <tbody>
                    {% for entry in weight_history %}
                    <tr>
                        <td>{{ entry.data }}</td>
                        <td>{{ entry.peso }} kg</td>
                        <td>
                            {% if loop.index > 1 %}
                                {% set diff = entry.peso - weight_history[loop.index - 2].peso %}
                                <span class="{% if diff < 0 %}text-success{% else %}text-danger{% endif %}">
                                    {{ "%.2f"|format(diff) }} kg
                                </span>
                            {% else %}
                                -
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <!-- Dicas Motivacionais -->
    <div class="tips-grid">
        <div class="tip-card">
            <h4>游눦 Hidrata칞칚o</h4>
            <p>Beba pelo menos 2 litros de 치gua por dia para manter o metabolismo ativo.</p>
        </div>
        <div class="tip-card">
            <h4>游끢 Exerc칤cios</h4>
            <p>Combine exerc칤cios aer칩bicos com muscula칞칚o para melhores resultados.</p>
        </div>
        <div class="tip-card">
            <h4>游땺 Sono</h4>
            <p>Durma 7-8 horas por noite. O sono adequado 칠 essencial para o emagrecimento.</p>
        </div>
        <div class="tip-card">
            <h4>游볭 Alimenta칞칚o</h4>
            <p>Priorize alimentos naturais e evite ultraprocessados.</p>
        </div>
    </div>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Define a data de hoje
    const today = new Date().toISOString().split('T')[0];
    const quickDataInput = document.getElementById('quick_data');
    if (quickDataInput) {
        quickDataInput.value = today;
    }

    // Formul치rio de perfil
    const profileForm = document.getElementById('profileForm');
    if (profileForm) {
        profileForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                nome: document.getElementById('nome').value,
                idade: document.getElementById('idade').value,
                sexo: document.getElementById('sexo').value,
                altura: document.getElementById('altura').value,
                peso_inicial: document.getElementById('peso_inicial').value,
                peso_meta: document.getElementById('peso_meta').value,
                nivel_atividade: document.getElementById('nivel_atividade').value,
                objetivo: document.getElementById('objetivo').value
            };
            
            try {
                const response = await fetch('/api/save-profile', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                if (result.success) {
                    alert('Perfil criado com sucesso!');
                    window.location.reload();
                }
            } catch (error) {
                alert('Erro ao salvar perfil: ' + error.message);
            }
        });
    }

    // Formul치rio de registro r치pido de peso
    const quickWeightForm = document.getElementById('quickWeightForm');
    if (quickWeightForm) {
        quickWeightForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                peso: document.getElementById('quick_peso').value,
                data: document.getElementById('quick_data').value
            };
            
            try {
                const response = await fetch('/api/add-weight', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                if (result.success) {
                    alert('Peso registrado com sucesso!');
                    window.location.reload();
                }
            } catch (error) {
                alert('Erro ao registrar peso: ' + error.message);
            }
        });
    }
});
</script>
{% endblock %}
